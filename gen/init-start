#!/bin/sh

/jffs/dnscrypt/fake-hwclock load

[ -f /jffs/dnscrypt/.config ] && . /jffs/dnscrypt/.config

init_hwrng () {
  modprobe cdc_acm
  COUNT=0
  while [ ! -c $RNG_DEV ]; do
    if [ $COUNT -gt 120 ]; then
      logger "ERROR: Unable to find HWRNG device. Aborting..."
      exit 1
    fi
    COUNT=$((COUNT+1))
    sleep 1
  done
  /jffs/dnscrypt/stty raw -echo -ixoff -F $RNG_DEV speed 115200
  /jffs/dnscrypt/rngd -r $RNG_DEV
  [ $? -eq 0 ] && logger "rngd: Started for $RNG_DEV"
}

case $RAN_PRV in
  haveged)
    /jffs/dnscrypt/haveged -w1024 -v1
    ;;
  rngd)
    init_hwrng &
    ;;
esac
