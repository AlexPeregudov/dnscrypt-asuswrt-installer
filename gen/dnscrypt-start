#!/bin/sh
[ `pidof $(basename $0)|wc -w` -gt 2 ] && exit 0
OPENDNS_USER=
OPENDNS_PASSWORD=

update_opendns () {
  ARG=$1
  [ $ARG -gt 2 ] && return
  RET=`curl -s -u "$OPENDNS_USER:$OPENDNS_PASSWORD" "https://updates.opendns.com/nic/update?hostname="`
  case "$RET" in
    good*)
      logger "OpenDNS: Update IP succeeded"
      ;;
    badauth*)
      logger "OpenDNS: Wrong username or password"
      ;;
    *)
      logger "OpenDNS: Received error $RET"
      sleep 1
      update_opendns $((ARG+1))
      ;;
  esac
}

(
while [ `nvram get ntp_ready` -eq 0 ]; do
  sleep 2
done

if [ "$OPENDNS_USER" ] && [ "$OPENDNS_PASSWORD" ]; then
  update_opendns 0
fi

if [ -z "`pidof dnscrypt-proxy`" ]; then
  /jffs/dnscrypt/nonroot nobody /jffs/dnscrypt/dnscrypt-proxy --local-address=127.0.0.1:65053 --daemonize --loglevel=4 -L /jffs/dnscrypt/dnscrypt-resolvers.csv -R cisco
  if [ $? -eq 0 ]; then
    logger "dnscrypt-proxy started"
    sleep 1
    service restart_dnsmasq
  else
    logger "ERROR: Unable to start dnscrypt-proxy"
  fi
fi
)&
