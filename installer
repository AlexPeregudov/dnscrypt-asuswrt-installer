#!/bin/sh

BOLD="\033[1m"
NORM="\033[0m"
INFO="$BOLD Info: $NORM"
ERROR="$BOLD *** Error: $NORM"
WARNING="$BOLD * Warning: $NORM"
INPUT="$BOLD => $NORM"

cd /tmp

echo -e "$INFO This script will install dnscrypt-proxy and related files (~0.5MB)"
echo -e "$INFO to jffs, no other data will be changed."
echo -e "$INFO Also some start scripts will be installed/modified as required."
echo

URL_GEN=https://raw.githubusercontent.com/thuantran/dnscrypt-asuswrt-installer/master/gen
URL_ARCH=https://github.com/thuantran/dnscrypt-asuswrt-installer/raw/master

finalize () {
  echo -e "$INFO dnscrypt setup completed!"
}

write_postconf () {
  MAGIC="########## dnscrypt-asuswrt-installer ##########"
  TARG=/jffs/scripts/dnsmasq.postconf
  if [ ! -f $TARG ]; then
    echo -e "$INFO Creating dnsmasq.postconf file"
    echo "#!/bin/sh" > $TARG
  fi
  chmod 755 $TARG

  BOUNDS=`grep -n dnscrypt-asuswrt-installer $TARG|cut -d':' -f1|xargs|tr ' ' ','`
  if [ "$BOUNDS" ]; then
    sed -i "${BOUNDS}d" $TARG
  fi

  if [ "`grep dnsmasq-dnscrypt-reconfig $TARG`" ]; then
    echo -e "$INFO dnsmasq.postconf file already configured"
  else
    echo -e "$INFO Configure dnsmasq.postconf file for dnscrypt"
    echo "/jffs/dnscrypt/dnsmasq-dnscrypt-reconfig" >> $TARG
  fi
}

inst_ip_update () {
  echo -en "$INPUT Please enter OpenDNS username$NORM: "
  read -r USERNAME
  echo -en "$INPUT Please enter OpenDNS password$NORM: "
  read -r PW1
  echo -en "$INPUT Please reenter OpenDNS password$NORM: "
  read -r PW2
  if [ "$PW1" != "$PW2" ]; then
    echo -e "$ERROR Password entered incorrectly! Exiting..."
    exit 1 
  fi

  TARG=/jffs/dnscrypt/dnscrypt-start
  sed -i "/^OPENDNS_USER=/s/$/\"$USERNAME\"/" $TARG
  sed -i "/^OPENDNS_PASSWORD=/s/$/\"$PW1\"/" $TARG
  finalize
}

update_ip () {
  echo -en "$INPUT Do you want to set up OpenDNS account ip update $BOLD[y/n]$NORM: "
  read YESNO
  case $YESNO in
    y|Y)
      inst_ip_update
      ;;
    n|N)
      finalize
      ;;
    *)
      echo -e "$ERROR Invalid input! Exiting..."
      exit 1
      ;;
  esac
}

inst_dnscrypt () {
  TARG=/jffs/dnscrypt
  CURL="curl -L -k -s -O"
  rm -rf $TARG
  mkdir -p $TARG
  if [ $? -ne 0 ]; then
    echo -e "$ERROR Unable to create $TARG! Exiting..."
    exit 1
  fi

  cd $TARG
  echo -e "$INFO Downloading dnscrypt-resolvers.csv"
  $CURL https://raw.githubusercontent.com/jedisct1/dnscrypt-proxy/master/dnscrypt-resolvers.csv && chmod 644 dnscrypt-resolvers.csv
  echo -e "$INFO Downloading dnsmasq-dnscrypt-reconfig"
  $CURL $URL_GEN/dnsmasq-dnscrypt-reconfig && chmod 755 dnsmasq-dnscrypt-reconfig
  echo -e "$INFO Downloading dnscrypt-start"
  $CURL $URL_GEN/dnscrypt-start && chmod 755 dnscrypt-start
  echo -e "$INFO Downloading dnscrypt-proxy"
  $CURL $URL_ARCH/dnscrypt-proxy && chmod 755 dnscrypt-proxy
  echo -e "$INFO Downloading nonroot"
  $CURL $URL_ARCH/nonroot && chmod 755 nonroot

  cd /jffs/scripts
  if [ ! -f wan-start ]; then
    echo -e "$INFO Creating wan-start file"
    echo "#!/bin/sh" > wan-start
    echo "" >> wan-start
  fi
  chmod 755 wan-start
  if [ "`grep dnscrypt-start wan-start`" ]; then
    echo -e "$INFO wan-start file already configured"
  else
    echo -e "$INFO Configure wan-start file for dnscrypt"
    echo "$TARG/dnscrypt-start" >> wan-start
  fi

  write_postconf
  update_ip
}

case $(uname -m) in
  armv7l)
    URL_ARCH=$URL_ARCH/armv7
    echo -e "$INFO Detected ARM architecture."
    echo
    ;;
  *)
    echo "This is unsupported platform, sorry."
    exit 1
    ;;
esac

echo -en "$INPUT Do you want to install dnscrypt-proxy to /jffs $BOLD[y/n]$NORM: "
read YESNO
case $YESNO in
  y|Y)
    inst_dnscrypt
    ;;
  n|N)
    exit 0
    ;;
  *)
    echo -e "$ERROR Invalid input! Exiting..."
    exit 1
    ;;
esac
