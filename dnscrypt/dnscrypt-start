[ `pidof $(basename $0)|wc -w` -gt 2 ] && logger "ddns-start quit due to multiple instances" && exit 0
OPENDNS_USER=""
OPENDNS_PASSWORD=""

(
while [ `nvram get ntp_ready` -eq 0 ]; do
  sleep 2
done

if [ "$OPENDNS_USER" ] && [ "$OPENDNS_PASSWORD" ]; then
  if [ "`curl -u "$OPENDNS_USER:$OPENDNS_PASSWORD" "https://updates.opendns.com/nic/update?hostname="|grep good`" ]; then
    logger "Update OpenDNS IP succeeded"
  else
    logger "Update OpenDNS IP failed"
  fi
fi

if [ -z "`pidof dnscrypt-proxy`" ]; then
  /jffs/dnscrypt/nonroot nobody /jffs/dnscrypt/dnscrypt-proxy --local-address=127.0.0.1:65053 --daemonize --loglevel=4 -L /jffs/dnscrypt/dnscrypt-resolvers.csv -R cisco
  if [ $? -eq 0 ]; then
    logger "dnscrypt-proxy started"
    sleep 1
    service restart_dnsmasq
  else
    logger "ERROR: Unable to start dnscrypt-proxy"
  fi
fi
)&
